name: Build & Release Obsidian plugin

on:
  push:
    tags:
      - 'v*'   # e.g., v0.1.0

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repo at the tag
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # If you have a package.json, prefer npm ci to install dev deps (esbuild, etc.)
      - name: Install deps (fallback)
        run: |
          npm init -y >/dev/null 2>&1 || true
          npm i --no-audit --no-fund esbuild@0.21.5 @popperjs/core

      - name: Build plugin with esbuild
        run: |
          npx esbuild src/main.ts \
            --bundle --outfile=main.js \
            --format=cjs --platform=browser \
            --external:obsidian --external:electron

      - name: Verify required files
        run: |
          test -f manifest.json
          test -f main.js
          # styles.css optional

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            manifest.json
            main.js
            styles.css
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
